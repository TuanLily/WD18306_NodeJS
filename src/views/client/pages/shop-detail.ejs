<!-- Start All Title Box -->
<div class="all-title-box">
  <div class="container">
    <div class="row">
      <div class="col-lg-12">
        <h2>Chi tiết sản phẩm</h2>
        <ul class="breadcrumb">
          <li class="breadcrumb-item"><a href="#">Cửa hàng</a></li>
          <li class="breadcrumb-item active">Chi tiết sản phẩm</li>
        </ul>
      </div>
    </div>
  </div>
</div>
<!-- End All Title Box -->

<!-- Start Shop Detail  -->
<div class="shop-detail-box-main">
  <div class="container">
    <div class="row">
      <div class="col-xl-5 col-lg-5 col-md-6">
        <div
          id="carousel-example-1"
          class="single-product-slider carousel slide"
          data-ride="carousel"
        >
          <div class="carousel-inner" role="listbox">
            <div class="carousel-item active">
              <img
                class="d-block w-100"
                src="../uploads/<%= product.image %>"
                alt="First slide"
              />
            </div>
            <div class="carousel-item">
              <img
                class="d-block w-100"
                src="../uploads/<%= product.image %>"
                alt="Second slide"
              />
            </div>
            <div class="carousel-item">
              <img
                class="d-block w-100"
                src="../uploads/<%= product.image %>"
                alt="Third slide"
              />
            </div>
          </div>
          <a
            class="carousel-control-prev"
            href="#carousel-example-1"
            role="button"
            data-slide="prev"
          >
            <i class="fa fa-angle-left" aria-hidden="true"></i>
            <span class="sr-only">Previous</span>
          </a>
          <a
            class="carousel-control-next"
            href="#carousel-example-1"
            role="button"
            data-slide="next"
          >
            <i class="fa fa-angle-right" aria-hidden="true"></i>
            <span class="sr-only">Next</span>
          </a>
          <ol class="carousel-indicators">
            <li
              data-target="#carousel-example-1"
              data-slide-to="0"
              class="active"
            >
              <img
                class="d-block w-100 img-fluid"
                src="../uploads/<%= product.image %>"
                alt=""
              />
            </li>
            <li data-target="#carousel-example-1" data-slide-to="1">
              <img
                class="d-block w-100 img-fluid"
                src="../uploads/<%= product.image %>"
                alt=""
              />
            </li>
            <li data-target="#carousel-example-1" data-slide-to="2">
              <img
                class="d-block w-100 img-fluid"
                src="../uploads/<%= product.image %>"
                alt=""
              />
            </li>
          </ol>
        </div>
      </div>
      <div class="col-xl-7 col-lg-7 col-md-6">
        <div class="single-product-details">
          <h2><%= product.name %></h2>
          <h5>
            <del><%= formatPrice(product.price) %></del> <%=
            formatPrice(product.sale_price) %>
          </h5>
          <p></p>
          <h4>Mô tả ngắn</h4>
          <p><%= product.description %></p>
          <ul>
            <li>
              <div class="form-group quantity-box">
                <label class="control-label">Số lượng</label>
                <input
                  class="form-control"
                  value="0"
                  min="0"
                  max="20"
                  type="number"
                />
              </div>
            </li>
          </ul>

          <div class="price-box-bar">
            <div class="cart-and-bay-btn">
              <a class="btn hvr-hover" data-fancybox-close="" href="#"
                >Thêm vào giỏ hàng</a
              >
            </div>
          </div>

          <div class="add-to-btn">
            <div class="add-comp">
              <a class="btn hvr-hover" href="#"
                ><i class="fas fa-heart"></i> Thêm vào mục yêu thích</a
              >
            </div>
            <div class="share-bar">
              <a class="btn hvr-hover" href="#"
                ><i class="fab fa-facebook" aria-hidden="true"></i
              ></a>
              <a class="btn hvr-hover" href="#"
                ><i class="fab fa-google-plus" aria-hidden="true"></i
              ></a>
              <a class="btn hvr-hover" href="#"
                ><i class="fab fa-twitter" aria-hidden="true"></i
              ></a>
              <a class="btn hvr-hover" href="#"
                ><i class="fab fa-pinterest-p" aria-hidden="true"></i
              ></a>
              <a class="btn hvr-hover" href="#"
                ><i class="fab fa-whatsapp" aria-hidden="true"></i
              ></a>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="row my-5">
      <div class="col-md-8">
        <div class="card card-outline-secondary my-4">
          <div class="card-header">
            <h2>Reviews sản phẩm</h2>
          </div>
          <div class="card-body">
            <!-- Nội dung của card -->
            <% if (comments && comments.length > 0) { %> <%
            comments.forEach(function(comment) { %>
            <div class="media mb-3">
              <div class="mr-2">
                <img
                  class="rounded-circle border p-1"
                  src="../../../public/client/images/man.png"
                  width="80"
                  alt="Generic placeholder image"
                />
              </div>
              <div class="media-body">
                <small class="text-muted">
                  Người đánh giá <strong><%= comment.fullname %> </strong>
                </small>
                <p style="font-size: 19px; font-weight: bold">
                  <%= comment.content %>
                </p>
                <small class="text-muted">
                  Thời gian: <%= formatDate(comment.created_at) %></small
                >
              </div>
            </div>
            <% }); %> <% } else { %>
            <!-- Hiển thị thông báo khi không có comment -->
            <p>Chưa có đánh giá nào, bạn muốn là người đầu tiên chứ?</p>
            <% } %>

            <hr />

            <!-- Form để thêm comment -->
            <!-- Kiểm tra nếu người dùng chưa đăng nhập -->
            <% if (!user) { %>
            <div class="alert alert-warning errMsg" role="alert">
              <p>Bạn cần đăng nhập trước khi đánh giá.</p>
            </div>
            <% } else { %>
            <form id="commentForm">
              <!-- Các trường ẩn để chứa user_id và product_id -->
              <input type="hidden" id="user_id" value="<%= user.id %>" />
              <input type="hidden" id="product_id" value="<%= product.id %>" />

              <div class="form-group">
                <label for="comment">Nhận xét của bạn:</label>
                <textarea
                  class="form-control"
                  id="comment"
                  rows="3"
                  required
                ></textarea>
              </div>
              <button type="submit" class="btn hvr-hover" style="color: #fff">
                Gửi nhận xét
              </button>
            </form>
            <% } %>
          </div>
        </div>
      </div>
    </div>

    <div class="row my-5">
      <div class="col-lg-12">
        <div class="title-all text-center">
          <h1>Có thể bạn thích</h1>
          <p>Sản phẩm có thể bạn quan tâm</p>
        </div>
        <div class="featured-products-box owl-carousel owl-theme">
          <% randomProduct.forEach((randomProduct) => { %>
          <div class="item">
            <div class="products-single fix">
              <div class="box-img-hover">
                <img
                  src="../uploads/<%= randomProduct.image %>"
                  class="img-fluid"
                  alt="Image"
                />
                <div class="mask-icon">
                  <ul>
                    <li>
                      <a
                        href="/shop-detail/<%= randomProduct.id %>"
                        data-toggle="tooltip"
                        data-placement="right"
                        title="Xem chi tiết"
                      >
                        <i class="fas fa-eye"></i>
                      </a>
                    </li>
                    <li>
                      <a
                        href="#"
                        data-toggle="tooltip"
                        data-placement="right"
                        title="Thêm vào mục yêu thích"
                      >
                        <i class="far fa-heart"></i>
                      </a>
                    </li>
                  </ul>
                  <a class="cart" href="#">Add to Cart</a>
                </div>
              </div>
              <div class="why-text">
                <h4><%= randomProduct.name %></h4>
                <h5><%= formatPrice(randomProduct.sale_price) %></h5>
              </div>
            </div>
          </div>
          <% }); %>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- End Cart -->

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const form = document.getElementById("commentForm");
    const user_id = document.getElementById("user_id").value;
    console.log(user_id);
    const product_id = document.getElementById("product_id").value;
    console.log(product_id);

    form.addEventListener("submit", function (event) {
      event.preventDefault();

      const commentContent = document.getElementById("comment").value;

      fetch("/addComment", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          user_id: user_id,
          product_id: product_id,
          content: commentContent,
        }),
      })
        .then((response) => response.json())
        .then((data) => {
          // Kiểm tra xem thêm nhận xét có thành công không
          if (data.success) {
            // Thêm nhận xét thành công, hiển thị thông báo SweetAlert2
            Swal.fire({
              icon: "success",
              title: "Thành công!",
              text: "Thêm nhận xét thành công!",
              timer: 1500, // Thời gian hiển thị là 1500ms
              showConfirmButton: false, // Ẩn nút button
              timerProgressBar: true, // Hiển thị thanh tiến trình thời gian
              didClose: () => {
                location.reload(); // Reload lại trang sau khi đóng SweetAlert2
              },
            });
          } else {
            // Thêm nhận xét không thành công, hiển thị thông báo SweetAlert2
            Swal.fire({
              icon: "error",
              title: "Lỗi!",
              text: "Có lỗi xảy ra khi thêm nhận xét!",
            });
          }
        })
        .catch((error) => {
          console.error("Error:", error);
        });
    });
  });
</script>
